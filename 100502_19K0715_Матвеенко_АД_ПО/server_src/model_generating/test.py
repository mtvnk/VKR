

import torch
from torch import nn
from torchvision import transforms
from PIL import Image
import io
import base64

class Network(nn.Module):
    def __init__(self):
        super(Network, self).__init__()
        self.hidden_0 = nn.Linear(784, 128)
        self.hidden_1 = nn.Linear(128, 64)
        self.output = nn.Linear(64, 10)
        self.softmax = nn.LogSoftmax(dim=1)
        self.activation = nn.ReLU()
        self.dropout = nn.Dropout(0.25)

    def forward(self, x):
        x = x.view(x.shape[0], -1)
        x = self.hidden_0(x)
        x = self.activation(x)
        x = self.dropout(x)
        x = self.hidden_1(x)
        x = self.activation(x)
        x = self.dropout(x)
        x = self.output(x)
        x = self.softmax(x)

        return x


def decode_image(image_data):
    image_data = image_data.split(",")[1]  # Убираем префикс "data:image/png;base64,"
    img_bytes = base64.b64decode(image_data)  # Декодируем base64 в байты
    img = Image.open(io.BytesIO(img_bytes))  # Открываем изображение с помощью PIL
    return img


def save_base64_image(base64_string, output_path):
    try:
        # Удаляем префикс, если он есть (например, "data:image/png;base64,")
        if "," in base64_string:
            base64_string = base64_string.split(",")[1]

        # Декодируем строку Base64
        image_data = base64.b64decode(base64_string)

        # Сохраняем декодированные данные в файл
        with open(output_path, "wb") as file:
            file.write(image_data)

        print(f"Изображение успешно сохранено по пути: {output_path}")
    except Exception as e:
        print(f"Ошибка при сохранении изображения: {e}")


weights = torch.load('../model/mnist_full_dataset.pth', map_location=torch.device('cpu'), weights_only=True)
model = Network()  # Замените на вашу модель
model.load_state_dict(weights)

# Перенос модели на доступное устройство (GPU или CPU)
device = 'cuda' if torch.cuda.is_available() else 'cpu'
model = model.to(device)

# Преобразования для входного изображения
transform = transforms.Compose([
    transforms.Grayscale(num_output_channels=1),  # Преобразуем в оттенки серого (если нужно)
    transforms.Resize((28, 28)),  # Размер изображения для MNIST (28x28)
    transforms.ToTensor(),  # Преобразуем в тензор
])


image_data = "data:image/png;base64,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fVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIKCJKwrVEYAQIEcggIkhx9UiUBAgTCCgiSsK1RGAECBHIICJIcfVIlAQIEwgoIkrCtURgBAgRyCAiSHH1SJQECBMIK/A8MHA7+ScQ/1wAAAABJRU5ErkJggg=="
image = decode_image(image_data)

save_base64_image(image_data, "output_image.png")

# Применяем преобразования
image = transform(image).unsqueeze(0)

image = image.to(device)




proba = torch.exp(model(image))
_, pred_label = torch.max(proba, dim=1)
print(pred_label.item())

